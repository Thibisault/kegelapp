<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>KegelApp</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#7c9df0" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" sizes="180x180" href="./icons/apple-touch-icon-180.png">

  <meta name="description" content="KegelApp : Timer simple, presets personnalis√©s, vibrations/sons/voix, mode √©cran noir.">

  <style>
    :root{
      --bg:#0b1020; --card:#121833; --muted:#a7b3e8; --text:#f3f5ff; --accent:#7c9df0; --accent-2:#47d1b3; --danger:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
      background:radial-gradient(1200px 800px at 70% -10%,#16214b 0%, var(--bg) 50%);
      color:var(--text);
    }
    header{padding:14px 16px; display:flex; align-items:center; justify-content:space-between}
    h1{font-size:18px; margin:0; letter-spacing:.2px}
    .nav{display:flex; gap:8px}
    .tab{padding:8px 12px; border-radius:999px; border:1px solid #2a3566; background:#0e1533; color:#cbd5ff; font-size:13px; cursor:pointer}
    .tab.active{background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#0b1020; border-color:transparent}

    main{max-width:820px; margin:0 auto; padding:8px 12px 84px}
    .view{display:none}
    .view.active{display:block}

    .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01) 40%), var(--card);
          border:1px solid rgba(255,255,255,.06); border-radius:18px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.25)}

    /* TIMER */
    .preset-pill{
      display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px;
      background:#0f1738; border:1px solid #2a3566; color:#e9edff; cursor:pointer; user-select:none
    }
    .preset-pill small{color:#a7b3e8}
    .display{display:flex; flex-direction:column; align-items:center; gap:14px; padding:8px}
    .ring{width:240px; height:240px}
    .phase{font-size:14px; color:#a7b3e8}
    .big{font-size:44px; font-weight:800; letter-spacing:1px}
    .counters{display:flex; gap:14px; color:#cbd5ff; font-size:13px}
    .progressbar{height:10px; width:100%; background:#132050; border-radius:999px; overflow:hidden; border:1px solid #253272}
    .progressbar__fill{height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--accent-2));}
    .btns{display:flex; gap:10px; flex-wrap:wrap; justify-content:center}
    button{
      appearance:none; border:0; border-radius:12px; padding:12px 16px; font-weight:600; cursor:pointer;
      background:var(--accent); color:#0b1020; transition:transform .06s ease, opacity .2s;
    }
    button.secondary{background:#25305f; color:#e8ecff}
    button.ghost{background:transparent; border:1px solid #33407a; color:#cbd5ff}
    button:active{transform:scale(.98)}
    .danger{background:var(--danger); color:white}

    .toggles{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:8px}
    .toggle{display:flex; align-items:center; gap:10px; padding:10px 12px; border:1px solid #2a3566; background:#0e1533; border-radius:12px}
    .toggle input{accent-color:var(--accent); width:20px; height:20px}
    .hint{font-size:12px; color:#a7b3e8; text-align:center}

    /* PRESETS */
    .list{display:grid; gap:12px}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .input{display:flex; flex-direction:column; gap:6px; background:#0e1533; border:1px solid #2a3566; padding:10px 12px; border-radius:12px}
    .input input{width:100%; background:transparent; color:var(--text); border:0; outline:0; font-size:16px}
    label{font-size:12px; color:#cbd5ff}
    .item{padding:12px; border-radius:14px; border:1px solid #263161; background:#0f1738}
    .item-header{display:flex; align-items:center; justify-content:space-between; gap:8px}

    /* FOOTER */
    footer{position:fixed; inset:auto 0 8px 0; display:flex; align-items:center; justify-content:center; pointer-events:none}
    .footer-inner{pointer-events:auto; background:#0f1738; border:1px solid #2a3566; padding:8px 10px; border-radius:12px; display:flex; gap:10px; align-items:center}
    .pill{font-size:12px; padding:6px 10px; border-radius:999px; background:#1a2344; color:#a7b3e8}

    /* ECONOMIE (√©cran noir) */
    #black{position:fixed; inset:0; background:#000; display:none; align-items:center; justify-content:center; z-index:9999; color:#444}
    #black.show{display:flex}
    #black p{user-select:none}

    .sr-only{position:absolute; left:-9999px}
  </style>
</head>
<body>
  <header>
    <h1>üü£ KegelApp</h1>
    <nav class="nav" role="tablist" aria-label="Navigation">
      <button id="tabTimer" class="tab active" role="tab" aria-selected="true">Timer</button>
      <button id="tabPresets" class="tab" role="tab" aria-selected="false">Presets</button>
    </nav>
  </header>

  <main>
    <!-- ===== Vue TIMER ===== -->
    <section id="viewTimer" class="view active" aria-labelledby="tabTimer">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <button class="preset-pill" id="presetPill" title="Appuyez pour passer au preset suivant" type="button">
            <small>Preset</small><b id="presetName">‚Äî</b>
          </button>
          <span class="pill" id="installHint">Hors-ligne pr√™t</span>
        </div>

        <div class="display">
          <svg class="ring" viewBox="0 0 120 120" aria-hidden="true">
            <circle cx="60" cy="60" r="52" stroke="#1e2a5a" stroke-width="10" fill="none"></circle>
            <circle id="ringProgress" cx="60" cy="60" r="52" stroke="url(#grad)" stroke-width="10" fill="none"
                    stroke-linecap="round" stroke-dasharray="326.725" stroke-dashoffset="326.725"
                    transform="rotate(-90 60 60)"></circle>
            <defs>
              <linearGradient id="grad" x1="0" x2="1">
                <stop offset="0%" stop-color="#7c9df0"></stop>
                <stop offset="100%" stop-color="#47d1b3"></stop>
              </linearGradient>
            </defs>
            <circle id="dot" cx="60" cy="8" r="3" fill="#47d1b3"></circle>
          </svg>

          <div class="phase" id="phaseLabel" aria-live="polite">Pr√™t ?</div>
          <div class="big" id="timeLeft">‚Äì:‚Äì</div>

          <div class="counters">
            <div>Set :<b id="setNum">0</b>/<b id="setTotal">0</b></div>
            <div>R√©p :<b id="repNum">0</b>/<b id="repTotal">0</b></div>
          </div>

          <div class="progressbar" aria-hidden="true"><div id="linearFill" class="progressbar__fill"></div></div>

          <div class="btns" style="margin-top:6px">
            <button id="startBtn" type="button">D√©marrer</button>
            <button id="pauseBtn" class="secondary" type="button">Pause</button>
            <button id="resetBtn" class="ghost" type="button">R√©initialiser</button>
          </div>

          <div class="toggles" role="group" aria-label="Options">
            <label class="toggle"><input type="checkbox" id="vibrate" checked> Vibrations</label>
            <label class="toggle"><input type="checkbox" id="beep" checked> Son</label>
            <label class="toggle"><input type="checkbox" id="voice"> Voix</label>
            <label class="toggle"><input type="checkbox" id="eco"> √âconomie d‚Äô√©cran</label>
          </div>

          <div class="hint">Astuce : touchez le nom du preset pour passer au suivant. La bascule ‚Äú√âconomie d‚Äô√©cran‚Äù noircit l‚Äô√©cran sans interrompre les sons/vibrations.</div>
          <div class="sr-only" aria-live="assertive" id="live"></div>
        </div>
      </div>
    </section>

    <!-- ===== Vue PRESETS ===== -->
    <section id="viewPresets" class="view" aria-labelledby="tabPresets">
      <div class="card">
        <h2 style="margin:0 0 12px 0; font-size:18px">Presets personnalis√©s</h2>
        <div class="list" id="presetList"></div>

        <div class="item" style="margin-top:12px">
          <div class="item-header"><b>Nouveau preset</b></div>
          <div class="row" style="margin-top:8px">
            <div class="input"><label for="np_name">Nom</label><input id="np_name" placeholder="Ex. Rapide 6/6"></div>
            <div class="input"><label for="np_prep">Pr√©paration (s)</label><input id="np_prep" type="number" min="0" value="5"></div>
          </div>
          <div class="row">
            <div class="input"><label for="np_sets">Sets</label><input id="np_sets" type="number" min="1" value="3"></div>
            <div class="input"><label for="np_reps">R√©p√©titions/set</label><input id="np_reps" type="number" min="1" value="10"></div>
          </div>
          <div class="row">
            <div class="input"><label for="np_c">Contraction (s)</label><input id="np_c" type="number" min="1" value="5"></div>
            <div class="input"><label for="np_r">Rel√¢chement (s)</label><input id="np_r" type="number" min="1" value="5"></div>
          </div>
          <div class="row">
            <div class="input"><label for="np_rest">Repos entre sets (s)</label><input id="np_rest" type="number" min="0" value="20"></div>
            <div class="input"><label>&nbsp;</label><button id="np_add" class="secondary" type="button">Ajouter</button></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- √âcran noir (√©conomie d‚Äô√©cran) -->
  <div id="black" role="dialog" aria-modal="true" aria-label="√âconomie d‚Äô√©cran activ√©e">
    <p>(Touchez pour quitter)</p>
  </div>

  <footer>
    <div class="footer-inner">
      <span>Installez l‚Äôapp pour un acc√®s rapide.</span>
    </div>
  </footer>

  <script>
  (() => {
    // ---------- Helpers ----------
    const $ = s => document.querySelector(s);
    const el = id => document.getElementById(id);
    const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
    const format = s => {
      s = Math.max(0, Math.round(s));
      return s>=60 ? `${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}` : `${s}s`;
    };

    // ---------- Views ----------
    const tabTimer = el('tabTimer'), tabPresets = el('tabPresets');
    const viewTimer = el('viewTimer'), viewPresets = el('viewPresets');
    function show(view){
      if(view==='timer'){
        viewTimer.classList.add('active'); tabTimer.classList.add('active'); tabTimer.setAttribute('aria-selected','true');
        viewPresets.classList.remove('active'); tabPresets.classList.remove('active'); tabPresets.setAttribute('aria-selected','false');
      }else{
        viewPresets.classList.add('active'); tabPresets.classList.add('active'); tabPresets.setAttribute('aria-selected','true');
        viewTimer.classList.remove('active'); tabTimer.classList.remove('active'); tabTimer.setAttribute('aria-selected','false');
      }
      history.replaceState({},'', '#'+view);
    }
    tabTimer.addEventListener('click', ()=>show('timer'));
    tabPresets.addEventListener('click', ()=>show('presets'));
    if(location.hash==='#presets') show('presets');

    // ---------- Elements (Timer) ----------
    const ring = el('ringProgress'), dot = el('dot'), timeLeftEl = el('timeLeft'), phaseLabel = el('phaseLabel');
    const setNumEl = el('setNum'), setTotalEl = el('setTotal'), repNumEl = el('repNum'), repTotalEl = el('repTotal'), linearFill = el('linearFill');
    const live = el('live'); const startBtn = el('startBtn'), pauseBtn = el('pauseBtn'), resetBtn = el('resetBtn');
    const presetPill = el('presetPill'), presetNameEl = el('presetName');
    const toggles = { vibrate: el('vibrate'), beep: el('beep'), voice: el('voice'), eco: el('eco') };
    const black = el('black');

    // ---------- Storage ----------
    const LS_SETTINGS = 'kegel.settings.v2';
    const LS_PRESETS  = 'kegel.presets.v1';
    const LS_SELECTED = 'kegel.selectedPresetIndex';

    const DEFAULTS = [
      { name:'D√©butant 5/5 √ó3√ó10', prep:5, sets:3, reps:10, c:5, r:5, rest:20 },
      { name:'Interm√©diaire 6/6 √ó3√ó12', prep:5, sets:3, reps:12, c:6, r:6, rest:25 },
      { name:'Avanc√© 8/8 √ó4√ó15', prep:5, sets:4, reps:15, c:8, r:8, rest:30 },
      { name:'Sprints 2/2 √ó2√ó20', prep:3, sets:2, reps:20, c:2, r:2, rest:15 }
    ];

    let presets = [];
    function loadPresets(){
      try{ presets = JSON.parse(localStorage.getItem(LS_PRESETS)||'[]'); }catch{ presets=[]; }
      if(!Array.isArray(presets) || presets.length===0){ presets = DEFAULTS.slice(); savePresets(); }
    }
    function savePresets(){ localStorage.setItem(LS_PRESETS, JSON.stringify(presets)); renderPresetList(); }

    function loadSettings(){
      try{
        const s = JSON.parse(localStorage.getItem(LS_SETTINGS)||'{}');
        ['vibrate','beep','voice','eco'].forEach(k=> toggles[k].checked = !!s[k]);
      }catch{}
      const sel = Number(localStorage.getItem(LS_SELECTED));
      if(!Number.isInteger(sel) || sel<0 || sel>=presets.length) localStorage.setItem(LS_SELECTED, '0');
    }
    function saveSettings(){
      const s = { vibrate:+toggles.vibrate.checked, beep:+toggles.beep.checked, voice:+toggles.voice.checked, eco:+toggles.eco.checked };
      localStorage.setItem(LS_SETTINGS, JSON.stringify(s));
    }
    Object.values(toggles).forEach(ch => ch.addEventListener('change', ()=>{
      saveSettings();
      if(ch===toggles.eco){
        if(toggles.eco.checked && playing){ black.classList.add('show'); }
        else { black.classList.remove('show'); }
      }
    }));

    // ---------- Preset selection ----------
    function currentIndex(){ return clamp(Number(localStorage.getItem(LS_SELECTED)||0), 0, presets.length-1); }
    function setIndex(i){ i = ((i%presets.length)+presets.length)%presets.length; localStorage.setItem(LS_SELECTED, String(i)); updatePresetUI(); }
    function currentPreset(){ return presets[currentIndex()]; }
    function updatePresetUI(){
      const p = currentPreset(); presetNameEl.textContent = p?.name || '‚Äî';
      setTotalEl.textContent = p?.sets || 0; repTotalEl.textContent = p?.reps || 0;
      resetUI();
    }
    presetPill.addEventListener('click', ()=> setIndex(currentIndex()+1));
    let startX=null;
    presetPill.addEventListener('touchstart',e=>startX=e.touches[0].clientX);
    presetPill.addEventListener('touchend',e=>{
      if(startX==null) return;
      const dx = e.changedTouches[0].clientX-startX;
      if(Math.abs(dx)>40) setIndex(currentIndex() + (dx<0?1:-1));
      startX=null;
    });

    // ---------- Audio / Beep ----------
    let audioCtx, gain;
    function beep(freq=880, dur=0.08){
      if(!toggles.beep.checked) return;
      try{
        audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
        gain = gain || audioCtx.createGain(); gain.connect(audioCtx.destination);
        const osc = audioCtx.createOscillator();
        osc.type = 'sine'; osc.frequency.value = freq;
        const g = audioCtx.createGain(); g.gain.value = 0.001;
        osc.connect(g); g.connect(gain);
        osc.start();
        g.gain.exponentialRampToValueAtTime(0.3, audioCtx.currentTime+0.02);
        g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+dur);
        osc.stop(audioCtx.currentTime+dur+0.02);
      }catch(e){}
    }

    // ---------- Speech ----------
    function speak(text){
      if(!toggles.voice.checked || !('speechSynthesis' in window)) return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'fr-FR'; u.rate = 1; u.pitch = 1.05;
      window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);
    }

    // ---------- Vibration ----------
    function vibrate(pattern){ if(toggles.vibrate.checked && navigator.vibrate) navigator.vibrate(pattern); }

    // ---------- Wake Lock ----------
    let wakeLock;
    async function lockScreen(){ try{ if('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); }catch(e){} }
    function releaseLock(){ try{ if(wakeLock){ wakeLock.release(); wakeLock=null; } }catch(e){} }

    // ---------- Sequence / Timer ----------
    const CIRC = 2*Math.PI*52;
    let seq = { phases:[], meta:{sets:0,reps:0} };
    let idx=0, startedAt=0, remaining=0, raf=0, playing=false;

    function buildPhasesFromPreset(p){
      const phases=[];
      if(p.prep>0) phases.push({type:'prep', label:'Pr√©parez-vous', dur:p.prep});
      for(let s=1;s<=p.sets;s++){
        for(let i=1;i<=p.reps;i++){
          phases.push({type:'contract', label:'Contractez', dur:p.c, set:s, rep:i, reps:p.reps, sets:p.sets});
          phases.push({type:'relax', label:'Rel√¢chez', dur:p.r, set:s, rep:i, reps:p.reps, sets:p.sets});
        }
        if(s<p.sets && p.rest>0) phases.push({type:'setrest', label:'Repos (entre sets)', dur:p.rest, set:s, reps:p.reps, sets:p.sets});
      }
      return {phases, meta:{sets:p.sets, reps:p.reps}};
    }

    function resetUI(){
      cancelAnimationFrame(raf);
      seq = buildPhasesFromPreset(currentPreset());
      idx=0; startedAt=0; remaining=seq.phases[0]?.dur||0; playing=false;
      ring.style.strokeDashoffset = CIRC;
      linearFill.style.width = '0%';
      dot.setAttribute('cx','60'); dot.setAttribute('cy','8');
      timeLeftEl.textContent = '‚Äì:‚Äì';
      phaseLabel.textContent = 'Pr√™t ?';
      setNumEl.textContent = '0'; repNumEl.textContent = '0';
      black.classList.remove('show');
      releaseLock();
    }

    function setPhase(p){
      phaseLabel.textContent = p.label;
      live.textContent = p.label;
      if(p.type==='contract'){ phaseLabel.style.color = '#9ed7cc'; beep(900,0.09); vibrate([60]); speak('Contractez'); }
      else if(p.type==='relax'){ phaseLabel.style.color = '#cbd5ff'; beep(660,0.08); vibrate([40]); speak('Rel√¢chez'); }
      else if(p.type==='setrest'){ phaseLabel.style.color = '#ffe29b'; beep(520,0.08); vibrate([100,30,100]); speak('Repos'); }
      else { phaseLabel.style.color = '#a7b3e8'; beep(700,0.06); }
      setNumEl.textContent = p.set || inferSet(idx); repNumEl.textContent = p.rep || ((p.type==='relax'||p.type==='contract') ? 1 : 0);
    }
    function inferSet(i){ let set=0; for(let k=0;k<=i;k++){ const ph = seq.phases[k]; if(ph?.type==='contract' && ph.set) set = ph.set; } return set; }

    function tick(){
      const p = seq.phases[idx]; if(!p){ finish(); return; }
      const now = performance.now();
      const elapsed = (now - startedAt)/1000;
      const remain = Math.max(0, remaining - elapsed);
      timeLeftEl.textContent = format(remain);

      const t = p.dur, frac = Math.max(0, Math.min(1, (t - remain)/t));
      ring.style.strokeDashoffset = CIRC*(1-frac);
      linearFill.style.width = ( (idx/seq.phases.length)*100 + frac*(100/seq.phases.length) ) + '%';

      const ang = (frac*360 - 90) * Math.PI/180;
      const cx = 60 + 52*Math.cos(ang), cy = 60 + 52*Math.sin(ang);
      dot.setAttribute('cx', cx.toFixed(2)); dot.setAttribute('cy', cy.toFixed(2));

      if(remain<=0.02){
        idx++;
        if(seq.phases[idx]){
          remaining = seq.phases[idx].dur; startedAt = performance.now(); setPhase(seq.phases[idx]);
          if(seq.phases[idx].rep) repNumEl.textContent = seq.phases[idx].rep;
          if(seq.phases[idx].set) setNumEl.textContent = seq.phases[idx].set;
        }else{ finish(); return; }
      }
      if(playing) raf = requestAnimationFrame(tick);
    }

    function start(){
      saveSettings();
      if(!playing){
        playing = true;
        if(idx===0){ setPhase(seq.phases[0]||{label:'Pr√™t',dur:0}); }
        startedAt = performance.now();
        lockScreen();
        if(toggles.eco.checked) black.classList.add('show');
        raf = requestAnimationFrame(tick);
      }
    }
    function pause(){
      if(!playing) return;
      playing = false; cancelAnimationFrame(raf);
      const elapsed = (performance.now()-startedAt)/1000; remaining = Math.max(0, remaining - elapsed);
      black.classList.remove('show'); releaseLock();
    }
    function resume(){
      if(playing) return;
      playing = true; startedAt = performance.now(); lockScreen(); if(toggles.eco.checked) black.classList.add('show');
      raf = requestAnimationFrame(tick);
    }
    function finish(){
      playing=false; cancelAnimationFrame(raf);
      ring.style.strokeDashoffset = 0; linearFill.style.width = '100%';
      phaseLabel.textContent = '‚úÖ S√©ance termin√©e'; timeLeftEl.textContent = 'Bien jou√© !';
      vibrate([200,50,200]); beep(990,0.12); beep(660,0.12); speak('S√©ance termin√©e. Bravo !');
      black.classList.remove('show'); releaseLock();
    }

    startBtn.addEventListener('click', ()=>{ if(idx===0 && !playing) start(); else resume(); });
    pauseBtn.addEventListener('click', pause);
    resetBtn.addEventListener('click', resetUI);

    // Quitter l‚Äô√©cran noir par tap
    black.addEventListener('click', ()=>{ toggles.eco.checked=false; saveSettings(); black.classList.remove('show'); });

    // ---------- Preset manager (View 2) ----------
    const list = el('presetList');
    function renderPresetList(){
      list.innerHTML = '';
      presets.forEach((p, i) => {
        const div = document.createElement('div');
        div.className='item';
        div.innerHTML = `
          <div class="item-header">
            <div><b>${p.name}</b> ${i===currentIndex()?'<span class="pill" style="margin-left:6px">S√©lectionn√©</span>':''}</div>
            <div class="btns">
              <button class="ghost" data-act="use" data-i="${i}" type="button">Utiliser</button>
              <button class="secondary" data-act="edit" data-i="${i}" type="button">√âditer</button>
              <button class="danger" data-act="del" data-i="${i}" type="button">Supprimer</button>
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <div class="input"><label>Nom</label><input data-k="name" value="${p.name}"></div>
            <div class="input"><label>Pr√©paration (s)</label><input type="number" min="0" data-k="prep" value="${p.prep}"></div>
          </div>
          <div class="row">
            <div class="input"><label>Sets</label><input type="number" min="1" data-k="sets" value="${p.sets}"></div>
            <div class="input"><label>R√©p√©titions/set</label><input type="number" min="1" data-k="reps" value="${p.reps}"></div>
          </div>
          <div class="row">
            <div class="input"><label>Contraction (s)</label><input type="number" min="1" data-k="c" value="${p.c}"></div>
            <div class="input"><label>Rel√¢chement (s)</label><input type="number" min="1" data-k="r" value="${p.r}"></div>
          </div>
          <div class="row">
            <div class="input"><label>Repos entre sets (s)</label><input type="number" min="0" data-k="rest" value="${p.rest}"></div>
            <div class="input"><label>&nbsp;</label><button class="secondary" data-act="save" data-i="${i}" type="button">Enregistrer</button></div>
          </div>
        `;
        list.appendChild(div);
      });
    }

    list.addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const i = Number(btn.dataset.i); const act = btn.dataset.act;
      if(act==='use'){ setIndex(i); show('timer'); }
      if(act==='del'){
        if(presets.length<=1){ alert('Gardez au moins un preset.'); return; }
        if(confirm('Supprimer ce preset ?')){ presets.splice(i,1); savePresets(); if(currentIndex()>=presets.length) setIndex(presets.length-1); }
      }
      if(act==='save'){
        const wrapper = btn.closest('.item');
        const data = {}; wrapper.querySelectorAll('input[data-k]').forEach(inp=> data[inp.dataset.k] = inp.type==='number' ? Number(inp.value) : inp.value);
        data.name = String(data.name||'Preset'); data.prep=clamp(data.prep,0,600); data.sets=clamp(data.sets,1,20);
        data.reps=clamp(data.reps,1,100); data.c=clamp(data.c,1,120); data.r=clamp(data.r,1,120); data.rest=clamp(data.rest,0,300);
        presets[i] = data; savePresets(); if(i===currentIndex()) updatePresetUI();
      }
    });

    // Ajouter nouveau preset
    el('np_add').addEventListener('click', ()=>{
      const data = {
        name: String(el('np_name').value || 'Preset'),
        prep: clamp(Number(el('np_prep').value),0,600),
        sets: clamp(Number(el('np_sets').value),1,20),
        reps: clamp(Number(el('np_reps').value),1,100),
        c: clamp(Number(el('np_c').value),1,120),
        r: clamp(Number(el('np_r').value),1,120),
        rest: clamp(Number(el('np_rest').value),0,300)
      };
      presets.push(data); savePresets();
      el('np_name').value=''; el('np_prep').value=5; el('np_sets').value=3; el('np_reps').value=10;
      el('np_c').value=5; el('np_r').value=5; el('np_rest').value=20;
    });

    // ---------- Service worker ----------
    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=> navigator.serviceWorker.register('./service-worker.js').catch(()=>{}));
    }

    // ---------- Init ----------
    loadPresets(); loadSettings(); renderPresetList(); updatePresetUI();
    window.addEventListener('hashchange', ()=>{ if(location.hash==='#presets') show('presets'); else show('timer'); });
  })();
  </script>
</body>
</html>
