<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>KegelApp</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#7c9df0" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" sizes="180x180" href="./icons/apple-touch-icon-180.png">

  <meta name="description" content="Application Kegel simple : cycles contraction/relÃ¢chement, vibrations, sons, voix, hors-ligne.">
  <style>
    :root{
      --bg:#0b1020; --card:#121833; --muted:#a7b3e8; --text:#f3f5ff; --accent:#7c9df0; --accent-2:#47d1b3; --danger:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Helvetica,Arial,sans-serif;
      background:radial-gradient(1200px 800px at 70% -10%,#16214b 0%, var(--bg) 50%);
      color:var(--text);
    }
    header{padding:16px 20px; display:flex; align-items:center; justify-content:space-between}
    h1{font-size:22px; margin:0; letter-spacing:0.3px}
    .pill{font-size:12px; padding:6px 10px; border-radius:999px; background:#1a2344; color:var(--muted)}
    main{max-width:900px; margin:0 auto; padding:12px 16px 80px}
    .grid{display:grid; gap:16px}
    @media (min-width:860px){ .grid{grid-template-columns: 1.2fr 1fr;} }

    .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01) 40%), var(--card);
          border:1px solid rgba(255,255,255,.06); border-radius:18px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .section-title{font-weight:600; margin:0 0 10px 0; color:#cbd5ff; letter-spacing:.2px}
    label{display:block; font-size:13px; color:#cbd5ff; margin-bottom:6px}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .input{
      display:flex; align-items:center; gap:8px; background:#0e1533; border:1px solid #2a3566;
      padding:10px 12px; border-radius:12px
    }
    .input input{width:100%; background:transparent; color:var(--text); border:0; outline:0; font-size:16px}
    .toggle{display:flex; align-items:center; gap:10px; padding:10px 12px; border:1px solid #2a3566; background:#0e1533; border-radius:12px}
    .toggle input{accent-color:var(--accent); width:20px; height:20px}
    .hint{font-size:12px; color:var(--muted)}
    .btns{display:flex; gap:10px; flex-wrap:wrap}
    button{
      appearance:none; border:0; border-radius:12px; padding:12px 16px; font-weight:600; cursor:pointer;
      background:var(--accent); color:#0b1020; transition:transform .06s ease, opacity .2s;
    }
    button.secondary{background:#25305f; color:#e8ecff}
    button.ghost{background:transparent; border:1px solid #33407a; color:#cbd5ff}
    button:active{transform:scale(.98)}
    .danger{background:var(--danger); color:white}
    .preset{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid #2a3566; background:#0e1533; cursor:pointer}
    .preset:active{transform:scale(.98)}

    /* Display */
    .display{display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px; padding:16px}
    .phase{font-size:14px; color:#a7b3e8; letter-spacing:.4px}
    .big{font-size:44px; font-weight:800; letter-spacing:1px}
    .counters{display:flex; gap:14px; color:#cbd5ff; font-size:13px}
    .ring{width:240px; height:240px}
    .progressbar{height:10px; width:100%; background:#132050; border-radius:999px; overflow:hidden; border:1px solid #253272}
    .progressbar__fill{height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--accent-2));}

    footer{position:fixed; inset:auto 0 8px 0; display:flex; align-items:center; justify-content:center; pointer-events:none}
    .footer-inner{pointer-events:auto; background:#0f1738; border:1px solid #2a3566; padding:8px 10px; border-radius:12px; display:flex; gap:10px; align-items:center}
    .a2hs{display:none}
    .sr-only{position:absolute; left:-9999px}
  </style>
</head>
<body>
  <header>
    <h1>ðŸŸ£ KegelApp</h1>
    <div class="pill" id="installHint">Hors-ligne prÃªt</div>
  </header>

  <main class="grid">
    <!-- Affichage / guidage -->
    <section class="card">
      <h2 class="section-title">SÃ©ance</h2>
      <div class="display">
        <!-- Anneau de progression -->
        <svg class="ring" viewBox="0 0 120 120" aria-hidden="true">
          <circle cx="60" cy="60" r="52" stroke="#1e2a5a" stroke-width="10" fill="none"/>
          <circle id="ringProgress" cx="60" cy="60" r="52" stroke="url(#grad)" stroke-width="10" fill="none"
                  stroke-linecap="round" stroke-dasharray="326.725" stroke-dashoffset="326.725"
                  transform="rotate(-90 60 60)"/>
          <defs>
            <linearGradient id="grad" x1="0" x2="1">
              <stop offset="0%" stop-color="#7c9df0"/>
              <stop offset="100%" stop-color="#47d1b3"/>
            </linearGradient>
          </defs>
          <!-- Point animÃ© -->
          <circle id="dot" cx="60" cy="8" r="3" fill="#47d1b3" />
        </svg>

        <div class="phase" id="phaseLabel" aria-live="polite">PrÃªt ?</div>
        <div class="big" id="timeLeft">â€“:â€“</div>

        <div class="counters">
          <div>Set :<b id="setNum">0</b>/<b id="setTotal">0</b></div>
          <div>RÃ©p :<b id="repNum">0</b>/<b id="repTotal">0</b></div>
        </div>

        <div class="progressbar" aria-hidden="true"><div id="linearFill" class="progressbar__fill"></div></div>

        <div class="btns" style="margin-top:6px">
          <button id="startBtn">DÃ©marrer</button>
          <button id="pauseBtn" class="secondary">Pause</button>
          <button id="resetBtn" class="ghost">RÃ©initialiser</button>
        </div>
        <div class="hint">Conseil : engagez les muscles du plancher pelvien, respirez normalement, Ã©vitez de contracter les abdos/fessiers.</div>
        <div class="sr-only" aria-live="assertive" id="live"></div>
      </div>
    </section>

    <!-- RÃ©glages -->
    <section class="card">
      <h2 class="section-title">RÃ©glages</h2>
      <div class="row">
        <div class="input"><label for="prep">PrÃ©paration (s)</label><input id="prep" type="number" min="0" value="5"></div>
        <div class="input"><label for="sets">Sets</label><input id="sets" type="number" min="1" value="3"></div>
      </div>
      <div class="row">
        <div class="input"><label for="contract">Contraction (s)</label><input id="contract" type="number" min="1" value="5"></div>
        <div class="input"><label for="relax">RelÃ¢chement (s)</label><input id="relax" type="number" min="1" value="5"></div>
      </div>
      <div class="row">
        <div class="input"><label for="reps">RÃ©pÃ©titions / set</label><input id="reps" type="number" min="1" value="10"></div>
        <div class="input"><label for="rest">Repos entre sets (s)</label><input id="rest" type="number" min="0" value="20"></div>
      </div>

      <div class="row">
        <label class="toggle"><input type="checkbox" id="vibrate" checked> Vibrations</label>
        <label class="toggle"><input type="checkbox" id="beep" checked> Bips sonores</label>
      </div>
      <div class="row">
        <label class="toggle"><input type="checkbox" id="voice"> Annonces vocales</label>
        <label class="toggle"><input type="checkbox" id="countdown" checked> Compte Ã  rebours visible</label>
      </div>

      <div style="margin:10px 0 6px">Presets rapides</div>
      <div class="btns">
        <button class="preset" data-preset="beginner">DÃ©butant (3Ã—10 â€¢ 5/5s)</button>
        <button class="preset" data-preset="intermediate">IntermÃ©diaire (3Ã—12 â€¢ 6/6s)</button>
        <button class="preset" data-preset="advanced">AvancÃ© (4Ã—15 â€¢ 8/8s)</button>
        <button class="preset" data-preset="sprint">Sprints (2Ã—20 â€¢ 2/2s)</button>
      </div>
      <div class="hint" style="margin-top:8px">Les rÃ©glages sont enregistrÃ©s localement sur cet appareil.</div>
    </section>
  </main>

  <footer>
    <div class="footer-inner">
      <span id="a2hsText">Installez lâ€™app pour un accÃ¨s rapide.</span>
      <button id="a2hsBtn" class="secondary a2hs">Installer</button>
    </div>
  </footer>

  <script>
  (() => {
    // ------- Utils --------
    const $ = sel => document.querySelector(sel);
    const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
    const format = s => {
      s = Math.max(0, Math.round(s));
      return s >= 60 ? `${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}` : `${s}s`;
    };

    // ------- Elements -------
    const ring = $('#ringProgress');
    const dot = $('#dot');
    const timeLeftEl = $('#timeLeft');
    const phaseLabel = $('#phaseLabel');
    const setNumEl = $('#setNum'), setTotalEl = $('#setTotal');
    const repNumEl = $('#repNum'), repTotalEl = $('#repTotal');
    const linearFill = $('#linearFill');
    const live = $('#live');

    const inputs = {
      prep: $('#prep'), sets: $('#sets'), reps: $('#reps'),
      contract: $('#contract'), relax: $('#relax'), rest: $('#rest'),
      vibrate: $('#vibrate'), beep: $('#beep'), voice: $('#voice'), countdown: $('#countdown')
    };

    const startBtn = $('#startBtn'), pauseBtn = $('#pauseBtn'), resetBtn = $('#resetBtn');

    // ------- Persist settings -------
    const LS_KEY = 'kegel.settings.v1';
    const load = () => {
      try { const s = JSON.parse(localStorage.getItem(LS_KEY)||'{}'); Object.entries(s).forEach(([k,v])=>{
        if(inputs[k]===undefined) return;
        if(typeof inputs[k].checked === 'boolean') inputs[k].checked = !!v;
        else inputs[k].value = v;
      }); } catch(e){}
    };
    const save = () => {
      const s={}; for(const [k,el] of Object.entries(inputs)){ s[k] = (typeof el.checked==='boolean') ? el.checked : Number(el.value); }
      localStorage.setItem(LS_KEY, JSON.stringify(s));
    };
    Object.values(inputs).forEach(el => el.addEventListener('change', save));
    load();

    // ------- Audio / Beep -------
    let audioCtx, gain;
    function beep(freq=880, dur=0.08){
      if(!inputs.beep.checked) return;
      try{
        audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
        gain = gain || audioCtx.createGain(); gain.connect(audioCtx.destination);
        const osc = audioCtx.createOscillator();
        osc.type = 'sine'; osc.frequency.value = freq;
        const g = audioCtx.createGain(); g.gain.value = 0.001; // start silent, ramp to avoid click
        osc.connect(g); g.connect(gain);
        osc.start();
        g.gain.exponentialRampToValueAtTime(0.3, audioCtx.currentTime+0.02);
        g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+dur);
        osc.stop(audioCtx.currentTime+dur+0.02);
      }catch(e){}
    }

    // ------- Speech (optional) -------
    function speak(text){
      if(!inputs.voice.checked || !('speechSynthesis' in window)) return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'fr-FR'; u.rate = 1; u.pitch = 1.1;
      window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);
    }

    // ------- Vibration -------
    function vibrate(pattern){ if(inputs.vibrate.checked && navigator.vibrate) navigator.vibrate(pattern); }

    // ------- Wake Lock -------
    let wakeLock;
    async function lockScreen(){
      try{
        if('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen');
      }catch(e){}
    }
    function releaseLock(){ try{ if(wakeLock) { wakeLock.release(); wakeLock = null; } }catch(e){} }

    // ------- Sequence builder -------
    function buildPhases(){
      const prep = clamp(Number(inputs.prep.value),0,600);
      const sets = clamp(Number(inputs.sets.value),1,20);
      const reps = clamp(Number(inputs.reps.value),1,100);
      const c = clamp(Number(inputs.contract.value),1,120);
      const r = clamp(Number(inputs.relax.value),1,120);
      const rest = clamp(Number(inputs.rest.value),0,300);
      const phases = [];
      if(prep>0) phases.push({type:'prep', label:'PrÃ©parez-vous', dur:prep});

      for(let s=1;s<=sets;s++){
        for(let i=1;i<=reps;i++){
          phases.push({type:'contract', label:'Contractez', dur:c, set:s, rep:i, reps, sets});
          phases.push({type:'relax', label:'RelÃ¢chez', dur:r, set:s, rep:i, reps, sets});
        }
        if(s<sets && rest>0) phases.push({type:'setrest', label:'Repos (entre sets)', dur:rest, set:s, reps, sets});
      }
      return {phases, meta:{sets,reps}};
    }

    // ------- Runner -------
    const CIRC = 2*Math.PI*52;
    let idx=0, startedAt=0, pausedAt=0, remaining=0, raf=0, playing=false;
    let seq = buildPhases(); setTotalEl.textContent = seq.meta.sets; repTotalEl.textContent = seq.meta.reps;

    function resetUI(){
      cancelAnimationFrame(raf);
      idx=0; startedAt=0; pausedAt=0; remaining=0; playing=false;
      ring.style.strokeDashoffset = CIRC;
      linearFill.style.width = '0%';
      dot.setAttribute('cx','60'); dot.setAttribute('cy','8');
      timeLeftEl.textContent = 'â€“:â€“';
      phaseLabel.textContent = 'PrÃªt ?';
      setNumEl.textContent = '0'; repNumEl.textContent = '0';
      releaseLock();
    }

    function setPhase(p){
      const label = p.label;
      phaseLabel.textContent = label;
      live.textContent = label;
      if(p.type==='contract'){ phaseLabel.style.color = '#9ed7cc'; beep(900,0.09); vibrate([60]); speak('Contractez'); }
      else if(p.type==='relax'){ phaseLabel.style.color = '#cbd5ff'; beep(660,0.08); vibrate([40]); speak('RelÃ¢chez'); }
      else if(p.type==='setrest'){ phaseLabel.style.color = '#ffe29b'; beep(520,0.08); vibrate([100,30,100]); speak('Repos'); }
      else { phaseLabel.style.color = '#a7b3e8'; beep(700,0.06); }
      setNumEl.textContent = p.set || idxSetOf(idx)+''; // best effort
      repNumEl.textContent = p.rep || ((p.type==='relax'||p.type==='contract') ? 1 : 0);
    }

    function idxSetOf(i){
      // Infer set number by scanning phases up to index i
      let set=0; for(let k=0;k<=i;k++){ const ph = seq.phases[k]; if(ph?.type==='contract' && ph.set) set = ph.set; }
      return set;
    }

    function tick(){
      const p = seq.phases[idx];
      if(!p){ finish(); return; }
      const now = performance.now();
      const elapsed = (now - startedAt) / 1000;
      const remain = Math.max(0, remaining - elapsed);
      timeLeftEl.textContent = inputs.countdown.checked ? format(remain) : '';
      // progress per phase
      const t = p.dur;
      const frac = clamp((t - remain) / t, 0, 1);
      const off = CIRC * (1 - frac);
      ring.style.strokeDashoffset = off;
      linearFill.style.width = ( (idx/seq.phases.length)*100 + frac*(100/seq.phases.length) ) + '%';

      // move dot around circle
      const ang = (frac*360 - 90) * Math.PI/180;
      const cx = 60 + 52*Math.cos(ang);
      const cy = 60 + 52*Math.sin(ang);
      dot.setAttribute('cx', cx.toFixed(2));
      dot.setAttribute('cy', cy.toFixed(2));

      if(remain<=0.02){
        idx++;
        if(seq.phases[idx]){
          remaining = seq.phases[idx].dur;
          startedAt = performance.now();
          setPhase(seq.phases[idx]);
          if(seq.phases[idx].rep) repNumEl.textContent = seq.phases[idx].rep;
          if(seq.phases[idx].set) setNumEl.textContent = seq.phases[idx].set;
        }else{
          finish(); return;
        }
      }
      if(playing) raf = requestAnimationFrame(tick);
    }

    function start(){
      save();
      seq = buildPhases();
      setTotalEl.textContent = seq.meta.sets; repTotalEl.textContent = seq.meta.reps;
      if(!playing){
        playing = true;
        if(idx===0){ idx = 0; remaining = seq.phases[0]?.dur || 0; setPhase(seq.phases[0]||{label:'PrÃªt',dur:0}); }
        startedAt = performance.now();
        lockScreen();
        raf = requestAnimationFrame(tick);
      }
    }

    function pause(){
      if(!playing) return;
      playing = false;
      cancelAnimationFrame(raf);
      pausedAt = performance.now();
      // freeze remaining
      const elapsed = (pausedAt - startedAt)/1000;
      remaining = Math.max(0, remaining - elapsed);
      releaseLock();
    }

    function resume(){
      if(playing) return;
      playing = true;
      startedAt = performance.now();
      lockScreen();
      raf = requestAnimationFrame(tick);
    }

    function finish(){
      playing=false; cancelAnimationFrame(raf);
      ring.style.strokeDashoffset = 0;
      linearFill.style.width = '100%';
      phaseLabel.textContent = 'âœ… SÃ©ance terminÃ©e';
      timeLeftEl.textContent = 'Bien jouÃ© !';
      vibrate([200,50,200]); beep(990,0.12); beep(660,0.12);
      speak('SÃ©ance terminÃ©e. Bravo !');
      releaseLock();
    }

    // ------- Buttons -------
    startBtn.addEventListener('click', () => {
      if(idx===0) start(); else resume();
    });
    pauseBtn.addEventListener('click', pause);
    resetBtn.addEventListener('click', resetUI);

    // Presets
    document.querySelectorAll('.preset').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const p = btn.dataset.preset;
        if(p==='beginner'){ inputs.sets.value=3; inputs.reps.value=10; inputs.contract.value=5; inputs.relax.value=5; inputs.rest.value=20; }
        if(p==='intermediate'){ inputs.sets.value=3; inputs.reps.value=12; inputs.contract.value=6; inputs.relax.value=6; inputs.rest.value=25; }
        if(p==='advanced'){ inputs.sets.value=4; inputs.reps.value=15; inputs.contract.value=8; inputs.relax.value=8; inputs.rest.value=30; }
        if(p==='sprint'){ inputs.sets.value=2; inputs.reps.value=20; inputs.contract.value=2; inputs.relax.value=2; inputs.rest.value=15; }
        save(); resetUI(); seq = buildPhases(); setTotalEl.textContent = seq.meta.sets; repTotalEl.textContent = seq.meta.reps;
      });
    });

    // ------- PWA install prompt -------
    let deferredPrompt=null;
    const a2hsBtn = document.getElementById('a2hsBtn');
    const a2hsText = document.getElementById('a2hsText');
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault(); deferredPrompt = e;
      a2hsBtn.style.display='inline-block'; a2hsBtn.classList.remove('a2hs');
      a2hsText.textContent = "Installer lâ€™application ?";
    });
    a2hsBtn.addEventListener('click', async () => {
      if(!deferredPrompt) return;
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      deferredPrompt = null;
      a2hsText.textContent = outcome==='accepted' ? "Merci ! Application installÃ©e." : "Installation annulÃ©e (vous pourrez rÃ©essayer).";
      a2hsBtn.style.display='none';
    });

    // ------- Service worker -------
    if('serviceWorker' in navigator){
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
      });
    }

    // Init
    resetUI(); // prepare ring etc.
  })();
  </script>
</body>
</html>
