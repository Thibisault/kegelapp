<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>KegelApp</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#7c9df0" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" sizes="180x180" href="./icons/apple-touch-icon-180.png">

  <style>
    :root{
      --bg:#0f1220; --card:#171a2b; --ink:#e8ebff; --muted:#a9b4ff;
      --accent:#7c9df0; --accent-2:#7fe3cf; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background: radial-gradient(1200px 800px at 80% -10%, #1a1f38 0, var(--bg) 50%),
                  radial-gradient(800px 1000px at -10% 120%, #1b2140 0, var(--bg) 60%);
      color:var(--ink); -webkit-tap-highlight-color: transparent;
    }
    header{position:sticky; top:0; z-index:5; background:linear-gradient(180deg, rgba(15,18,32,.95), rgba(15,18,32,.7) 70%, transparent); backdrop-filter:saturate(120%) blur(8px); padding:18px 16px 8px;}
    .brand{display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.3px}
    .brand .dot{width:12px;height:12px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent-2)); box-shadow:0 0 24px rgba(127,227,207,.6)}
    .brand small{display:block; color:var(--muted); font-weight:500}

    main{padding: 18px 14px 24px; max-width:820px; margin: 0 auto;}
    .card{background:linear-gradient(180deg,#1a1e33,#14182a); border:1px solid #2b3159; border-radius:var(--radius); box-shadow:var(--shadow); padding:16px;}
    .grid{display:grid; gap:14px}
    @media(min-width:720px){ .grid{ grid-template-columns: 1.2fr 1fr } }
    .landscape .grid{ grid-template-columns: 1fr 1fr }

    .controls{display:grid; gap:10px}
    .row{display:flex; gap:8px; align-items:center; justify-content:space-between}
    .row > * { flex:1 }
    label{font-size:13px; color:var(--muted); margin-bottom:6px; display:block}
    select, input[type="number"]{
      width:100%; padding:12px 14px; border-radius:14px; border:1px solid #2b3159; background:#0f1326; color:var(--ink);
      outline:none;
    }
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:10px; border-radius:16px; padding:12px 16px; border:1px solid #2b3159; color:var(--ink); background:#0f1326; cursor:pointer; user-select:none; text-decoration:none; font-weight:600;}
    .btn.primary{ background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#0d1124; border-color:transparent }
    .btn:disabled{ opacity:.5; pointer-events:none }
    .badges{display:flex; flex-wrap:wrap; gap:8px}
    .badge{ font-size:12px; padding:6px 10px; border-radius:999px; background:#101532; border:1px solid #26305b; color:var(--muted) }

    .timer{ display:grid; place-items:center; gap:14px; padding:12px; }
    .ring{ position:relative; width:min(70vw,360px); aspect-ratio:1; }
    .ring svg{ position:absolute; inset:0; transform: rotate(-90deg) }
    .ring .value{ position:absolute; inset:0; display:grid; place-items:center; text-align:center; }
    .digits{ font-size:clamp(44px,9vw,68px); line-height:1; font-weight:800; letter-spacing:1px }
    .phase{ font-size:14px; color:var(--muted); letter-spacing:.6px; text-transform:uppercase }
    .hints{ font-size:12px; color:var(--muted); text-align:center }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <span class="dot" aria-hidden="true"></span>
      <div>KegelApp<br><small>Exercices, rythmes & minuteurs personnalisés</small></div>
      <span style="flex:1"></span>
      <!-- (boutons d’installation supprimés) -->
    </div>
  </header>

  <main id="app" class="grid">
    <section class="card">
      <h2 style="margin:6px 0 10px">Séance</h2>
      <div class="controls">
        <div>
          <label for="program">Type d’exercice</label>
          <select id="program">
            <option value="custom">— Personnalisé —</option>
            <option value='{"title":"Débutant","prep":5,"squeeze":5,"relax":5,"cycles":10,"sets":1,"rest":20}'>Débutant · 5s/5s ×10</option>
            <option value='{"title":"Endurance","prep":8,"squeeze":10,"relax":10,"cycles":12,"sets":1,"rest":30}'>Endurance · 10s/10s ×12</option>
            <option value='{"title":"Impulsions","prep":5,"squeeze":2,"relax":2,"cycles":30,"sets":2,"rest":25}'>Impulsions · 2s/2s ×30 · 2 séries</option>
            <option value='{"title":"Pyramide","prep":6,"squeeze":3,"relax":5,"cycles":16,"sets":1,"rest":30}'>Pyramide légère</option>
          </select>
        </div>

        <div class="row">
          <div><label>Préparation (s)</label><input id="prep" type="number" min="0" value="5"></div>
          <div><label>Serrer (s)</label><input id="squeeze" type="number" min="1" value="5"></div>
          <div><label>Relâcher (s)</label><input id="relax" type="number" min="1" value="5"></div>
        </div>

        <div class="row">
          <div><label>Cycles</label><input id="cycles" type="number" min="1" value="10"></div>
          <div><label>Séries</label><input id="sets" type="number" min="1" value="1"></div>
          <div><label>Repos entre séries (s)</label><input id="rest" type="number" min="0" value="20"></div>
        </div>

        <div class="row">
          <button id="start" class="btn primary">Démarrer</button>
          <button id="stop" class="btn" disabled>Stop</button>
        </div>

        <div class="badges">
          <span class="badge" id="statusOffline">Hors-ligne prêt</span>
          <span class="badge" id="statusLock">Veille</span>
          <span class="badge" id="statusOrient">Orientation</span>
          <span class="badge">Vibration</span>
          <span class="badge">Audio</span>
          <span class="badge" id="statusFs">Plein écran</span>
        </div>
      </div>
    </section>

    <section class="card timer">
      <div class="ring" aria-live="polite">
        <svg viewBox="0 0 100 100">
          <circle cx="50" cy="50" r="45" fill="none" stroke="#1f2546" stroke-width="10"></circle>
          <circle id="progress" cx="50" cy="50" r="45" fill="none" stroke="url(#g)" stroke-width="10" stroke-linecap="round" stroke-dasharray="282.743" stroke-dashoffset="282.743"></circle>
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#7c9df0"></stop>
              <stop offset="100%" stop-color="#7fe3cf"></stop>
            </linearGradient>
          </defs>
        </svg>
        <div class="value">
          <div class="digits" id="time">00:05</div>
          <div class="phase" id="phase">Prêt ?</div>
        </div>
      </div>
      <div class="hints">Conseils : respire, ne contracte pas les abdos/fessiers. Tourne le téléphone : l’interface s’adapte automatiquement.</div>
    </section>
  </main>

  <script>
    // ====== Helpers ======
    const $ = s => document.querySelector(s);
    const fmt = s => { s=Math.max(0,Math.round(s)); const m=Math.floor(s/60).toString().padStart(2,'0'); const ss=(s%60).toString().padStart(2,'0'); return `${m}:${ss}` };

    // ====== Orientation UI ======
    const mql = window.matchMedia('(orientation: landscape)');
    function applyOrientation(){
      const landscape = mql.matches || (innerWidth>innerHeight);
      document.body.classList.toggle('landscape', landscape);
      $('#statusOrient').textContent = 'Orientation: ' + (landscape ? 'paysage' : 'portrait');
    }
    (mql.addEventListener? mql.addEventListener('change',applyOrientation) : mql.addListener(applyOrientation));
    addEventListener('resize', applyOrientation);
    applyOrientation();

    // ====== Fullscreen (au clic sur Démarrer) ======
    function requestFull(){
      const el = document.documentElement;
      if(!document.fullscreenElement && el.requestFullscreen){
        el.requestFullscreen().then(()=>$('#statusFs').textContent='Plein écran: ON').catch(()=>{});
      }
    }
    document.addEventListener('fullscreenchange', ()=>$('#statusFs').textContent = 'Plein écran' + (document.fullscreenElement?': ON':': OFF'));

    // ====== Wake Lock ======
    let wakeLock;
    async function lockScreen(){
      try{
        wakeLock = await navigator.wakeLock.request('screen');
        $('#statusLock').textContent = 'Veille: activée';
        wakeLock.addEventListener('release', ()=>$('#statusLock').textContent='Veille');
      }catch(e){ $('#statusLock').textContent = 'Veille non dispo'; }
    }
    document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible' && state.running) lockScreen(); });

    // ====== Minuteur : état + boucle lissée (jamais figée) ======
    const CIRC = 2*Math.PI*45; const $prog = $('#progress');
    function setProgress(p){ $prog.style.strokeDasharray=CIRC.toFixed(3); $prog.style.strokeDashoffset=(CIRC*(1-Math.min(1,Math.max(0,p)))).toFixed(3); }

    const state = {
      prep:+$('#prep').value, squeeze:+$('#squeeze').value, relax:+$('#relax').value,
      cycles:+$('#cycles').value, sets:+$('#sets').value, rest:+$('#rest').value,
      running:false, phase:'idle', cycleIndex:0, setIndex:0, totalPhase:0, startTs:0, raf:0
    };

    function readInputs(){
      state.prep=+$('#prep').value; state.squeeze=+$('#squeeze').value; state.relax=+$('#relax').value;
      state.cycles=+$('#cycles').value; state.sets=+$('#sets').value; state.rest=+$('#rest').value;
      localStorage.setItem('kegelapp:v1', JSON.stringify({prep:state.prep,squeeze:state.squeeze,relax:state.relax,cycles:state.cycles,sets:state.sets,rest:state.rest}));
    }
    (function load(){ try{ const s=JSON.parse(localStorage.getItem('kegelapp:v1')); if(s){ for(const k in s){ const el=document.getElementById(k); if(el) el.value=s[k]; } } }catch{} })();
    document.querySelectorAll('input,select').forEach(el=>el.addEventListener('change', readInputs));

    function labelPhase(ph){
      return ph==='prepare'?'Préparation': ph==='squeeze'?'Serrer': ph==='relax'?'Relâcher': ph==='rest'?'Repos': ph==='done'?'Terminé':'';
    }
    function feedback(ph){
      try{
        if(ph==='squeeze'){ navigator.vibrate?.([80,40,80]); beep(120,920); }
        else if(ph==='relax'){ navigator.vibrate?.(60); beep(90,640); }
        else if(ph==='rest'){ navigator.vibrate?.([100,50,100,50,120]); beep(180,520); }
      }catch{}
    }

    let audioCtx;
    function beep(ms=140,freq=880){
      try{
        audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
        const o=audioCtx.createOscillator(), g=audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        o.type='sine'; o.frequency.value=freq;
        g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.4, audioCtx.currentTime+0.02);
        o.start();
        setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.02); o.stop(); }, ms);
      }catch{}
    }

    function setPhase(phase,dur){
      state.phase=phase; state.totalPhase=dur; state.startTs=performance.now();
      $('#phase').textContent=labelPhase(phase); $('#time').textContent=fmt(dur); setProgress(0); feedback(phase);
    }

    function nextPhase(){
      if(state.phase==='prepare'){ state.cycleIndex=0; state.setIndex=0; setPhase('squeeze', state.squeeze); }
      else if(state.phase==='squeeze'){ setPhase('relax', state.relax); }
      else if(state.phase==='relax'){
        state.cycleIndex++;
        if(state.cycleIndex < state.cycles) setPhase('squeeze', state.squeeze);
        else{
          state.setIndex++;
          if(state.setIndex < state.sets) setPhase('rest', state.rest);
          else { setPhase('done',0); stopTimer(); }
        }
      }
      else if(state.phase==='rest'){ state.cycleIndex=0; setPhase('squeeze', state.squeeze); }
    }

    function loop(ts){
      if(!state.running){ return; }
      const elapsed=(ts-state.startTs)/1000;
      if(state.totalPhase>0){
        const left=Math.max(0,state.totalPhase-elapsed);
        $('#time').textContent=fmt(left);
        setProgress(elapsed/state.totalPhase);
        if(elapsed>=state.totalPhase){ nextPhase(); }
      }
      state.raf=requestAnimationFrame(loop); // <= RAF toujours programmé → plus de gel
    }

    function startTimer(){
      readInputs();
      state.running=true;
      $('#start').disabled=true; $('#stop').disabled=false;
      requestFull(); lockScreen();
      setPhase('prepare', state.prep);
      cancelAnimationFrame(state.raf);
      state.raf=requestAnimationFrame(loop);
    }
    function stopTimer(){
      state.running=false;
      cancelAnimationFrame(state.raf);
      $('#start').disabled=false; $('#stop').disabled=true;
      $('#phase').textContent='Pause';
      try{ wakeLock?.release(); }catch{}
    }
    $('#start').addEventListener('click', startTimer);
    $('#stop').addEventListener('click', stopTimer);

    // ====== Service worker ======
    if('serviceWorker' in navigator){
      addEventListener('load', async ()=>{
        try{ await navigator.serviceWorker.register('./sw.js', {scope:'./'}); $('#statusOffline').textContent='Hors-ligne: OK'; }
        catch{ $('#statusOffline').textContent='Hors-ligne indisponible'; }
      });
    }
  </script>
</body>
</html>
