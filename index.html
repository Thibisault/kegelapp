<!doctype html>
<html lang="fr">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kegel ‚Äì Fonctions sexuelles (avec difficult√© globale)</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#317EFB">

  <!-- iOS (plein √©cran + ic√¥ne) -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon-180.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="icons/icon-192.png">

  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#334155; --text:#e5e7eb;
      --accent:#22c55e; --accent-weak:#16a34a; --red:#ef4444; --border:#1f2937;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:20px; background:linear-gradient(180deg,#0b1220,#0f172a 120%);
      color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      display:flex; justify-content:center;
    }
    .app{width:100%; max-width:960px; display:grid; gap:14px}
    h1{margin:0 0 6px; font-size:clamp(22px,4vw,32px)}
    .subtle{opacity:.85; font-size:.95rem}
    .card{
      background:rgba(17,24,39,.85); border:1px solid var(--border); border-radius:16px; padding:16px;
      box-shadow:0 8px 24px rgba(0,0,0,.25); backdrop-filter: blur(6px);
    }
    .grid{display:grid; gap:12px}
    @media(min-width:900px){ .grid-2{grid-template-columns:1.2fr .8fr} }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    label{font-size:.95rem; opacity:.9}
    select{
      background:#0b1220; border:1px solid var(--border); color:var(--text);
      border-radius:10px; padding:10px 12px; min-height:42px; width:100%;
    }
    button{
      border:0; border-radius:12px; padding:12px 16px; font-weight:700; cursor:pointer; color:white; background:var(--muted);
      transition:.15s transform ease, .15s filter ease; min-height:44px;
    }
    button:hover{filter:brightness(1.07)} button:active{transform:translateY(1px)}
    .primary{background:linear-gradient(180deg,var(--accent),var(--accent-weak))}
    .ghost{background:#0b1220; border:1px solid #293042}
    .danger{background:linear-gradient(180deg,#ef4444,#b91c1c)}
    .badge{display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px; background:#0b1220; border:1px solid #253042; font-size:.9rem}
    .big{font-size:clamp(40px,10vw,64px); font-weight:800; letter-spacing:1px; margin:4px 0 6px; text-align:center}
    .sub{text-align:center; opacity:.9}
    .progress{height:16px; background:#0b1220; border:1px solid var(--border); border-radius:999px; overflow:hidden}
    .bar{height:100%; width:0%; background:linear-gradient(90deg,#22c55e,#86efac)}
    .kpi{display:flex; justify-content:space-between; font-variant-numeric:tabular-nums}
    .list{display:flex; flex-wrap:wrap; gap:8px}

    /* Aide */
    details.help{border:1px solid #273043; border-radius:12px; padding:10px 12px; background:#0b1220}
    details.help[open]{background:#0c1426}
    details.help summary{cursor:pointer; font-weight:700; margin-bottom:6px}
    ul{margin:6px 0 0 18px}
    small{opacity:.8}

    /* Barre de difficult√© (10 carr√©s) */
    .diff-wrap{display:flex; align-items:center; gap:12px}
    .diffbar{ display:flex; gap:6px; align-items:center; outline:none; }
    .cell{
      width:26px; height:26px; border-radius:6px; border:1px solid #253042; background:#0b1220;
      transition:transform .12s ease, filter .12s ease, background .12s ease;
    }
    .cell.active{background:linear-gradient(180deg,var(--accent),var(--accent-weak)); border-color:#1f8e4d}
    .cell:hover{filter:brightness(1.07); cursor:pointer}
    .diff-text{min-width:140px; font-variant-numeric:tabular-nums}
    .hint{font-size:.9rem; opacity:.85}
  </style>

  <!-- Enregistrement du Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function () {
        navigator.serviceWorker.register('sw.js').catch(function (err) {
          console.error('Erreur d‚Äôenregistrement du Service Worker:', err);
        });
      });
    }
  </script>
</head>

<body>
  <main class="app">
    <header>
      <h1>Kegel ‚Äì Fonctions sexuelles masculines</h1>
      <div class="subtle">R√©glez la <b>difficult√© globale</b>, choisissez une <b>cat√©gorie</b> puis un <b>exercice</b>. Lisez l‚Äô<b>Aide & Technique</b>, puis appuyez sur <b>D√©marrer</b>.</div>
    </header>

    <!-- Barre de difficult√© globale -->
    <section class="card">
      <label for="diffBar" class="hint">Difficult√© globale (agit sur tous les exercices)</label>
      <div class="diff-wrap">
        <div id="diffBar" class="diffbar" role="slider" aria-label="Difficult√©"
             aria-valuemin="1" aria-valuemax="10" aria-valuenow="5" tabindex="0">
          <!-- Carr√©s inject√©s par JS -->
        </div>
        <div id="diffText" class="diff-text">5/10 ‚Äî Mod√©r√©</div>
      </div>
      <div class="hint">Astuce¬†: ajustez la difficult√© <b>avant</b> de d√©marrer. Si vous la changez pendant un timer, elle s‚Äôappliquera √† la s√©ance suivante.</div>
    </section>

    <section class="card grid grid-2">
      <!-- Colonne gauche: S√©lection & Aide -->
      <div class="grid">
        <div class="grid">
          <label for="catSelect">Cat√©gorie (objectif)</label>
          <select id="catSelect" aria-label="Cat√©gorie"></select>
        </div>

        <div class="grid">
          <label for="exSelect">Exercice</label>
          <select id="exSelect" aria-label="Exercice"></select>
          <div id="exSummary" class="list"></div>
        </div>

        <details class="help" open>
          <summary>Aide & technique</summary>
          <div id="helpContent"></div>
        </details>

        <div class="row">
          <label class="badge"><input type="checkbox" id="soundToggle">&nbsp;Son</label>
          <label class="badge"><input type="checkbox" id="vibrateToggle">&nbsp;Vibration</label>
          <label class="badge"><input type="checkbox" id="wakeToggle">&nbsp;Garder l‚Äô√©cran allum√©</label>
        </div>
        <small>En cas de douleur/tension pelvienne persistante ou de troubles urinaires, r√©duisez l‚Äôintensit√©, privil√©giez les <i>reverse Kegels</i>, et demandez un avis professionnel.</small>
      </div>

      <!-- Colonne droite: Timer -->
      <div class="grid">
        <div class="sub" id="phaseLabel">Pr√™t</div>
        <div class="big" id="timeDisplay">00:00</div>
        <div class="kpi">
          <div>√âtape&nbsp;: <span id="stepDisplay">0</span></div>
          <div>Dur√©e √©tape&nbsp;: <span id="stepDurDisplay">0s</span></div>
        </div>
        <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-label="Progression">
          <div class="bar" id="progressBar"></div>
        </div>
        <div class="row">
          <button id="startBtn" class="primary">D√©marrer</button>
          <button id="pauseBtn" class="ghost" disabled>Pause</button>
          <button id="resetBtn" class="danger" disabled>R√©initialiser</button>
        </div>
      </div>
    </section>

    <footer class="subtle">
      <small>Application √©ducative¬†: r√©glages g√©n√©raux bas√©s sur de bonnes pratiques de plancher pelvien. Z√©ro douleur, souffle libre, rel√¢che complet entre phases.</small>
    </footer>
  </main>

  <script>
    // ====== Donn√©es : cat√©gories & exercices (param√®tres de base) ======
    // Types:
    // - 'interval' : alternance travail/repos avec r√©p√©titions et cycles
    // - 'sequence' : liste d'√©tapes nomm√©es, avec cycles
    // - 'info'     : fiche aide sans timer
    // Chaque exercice a un "profile" d√©finissant la fa√ßon d'adapter la difficult√©.
    const CATEGORIES = [
      {
        id:'erection', name:'√ârection & maintien', exercises:[
          { id:'slow',   name:'Lentes (endurance)',   type:'interval', labels:{work:'Contraction', rest:'Repos'},
            base:{work:5, rest:5, reps:12, cycles:1, restBetweenCycles:0}, profile:'endurance',
            help:{
              tech:['‚ÄúFermer & remonter‚Äù autour de l‚Äôur√®tre et de l‚Äôanus, sans serrer fessiers ni rentrer le ventre.'],
              breath:['Expirez en contractant, inspirez en rel√¢chant.'],
              errors:['√âvitez la pouss√©e vers le bas et le blocage du souffle.'],
              progress:['Progresser: allong√© ‚Üí assis ‚Üí debout.']
            }
          },
          { id:'quick',  name:'Rapides (r√©activit√©)', type:'interval', labels:{work:'Contraction rapide', rest:'Rel√¢che'},
            base:{work:1, rest:1, reps:30, cycles:1, restBetweenCycles:0}, profile:'quick',
            help:{
              tech:['Contractions br√®ves, nettes, sans crispation globale.'],
              breath:['Souffle fluide ; micro‚Äëexpirs possibles.'],
              errors:['Ne serrez pas les fessiers.'],
              progress:['Augmentez par paquets de 5.']
            }
          },
          { id:'long',   name:'Longues tenues (avanc√©)', type:'interval', labels:{work:'Contraction longue', rest:'Repos long'},
            base:{work:20, rest:40, reps:5, cycles:1, restBetweenCycles:0}, profile:'longholds',
            help:{
              tech:['Tonus stable, nuque d√©tendue, aucune compensation abdominale.'],
              breath:['Expirations lentes ; rel√¢che complet au repos.'],
              errors:['Si tremblements/compensations: r√©duisez la tenue.'],
              progress:['Augmenter par pas de 5 s maximum.']
            }
          },
          { id:'ladder', name:'Pyramide (2‚Äë4‚Äë6‚Äë8‚Äë6‚Äë4‚Äë2)', type:'sequence',
            steps:[{label:'2 s',seconds:2},{label:'4 s',seconds:4},{label:'6 s',seconds:6},{label:'8 s',seconds:8},{label:'6 s',seconds:6},{label:'4 s',seconds:4},{label:'2 s',seconds:2}],
            base:{cycles:1, restBetweenCycles:0}, profile:'pyramid',
            help:{
              tech:['Montez puis redescendez, qualit√© du rel√¢che √† chaque √©tape.'],
              breath:['L‚Äôexpiration accompagne les √©tapes longues.'],
              errors:['Ne grimpez pas √† 100 % d‚Äôun coup.'],
              progress:['Ajoutez un 2·µâ cycle quand facile.']
            }
          },
          { id:'elevator', name:'Ascenseur (25‚Üí100‚Üí25 %)', type:'sequence',
            steps:[{label:'25 %',seconds:3},{label:'50 %',seconds:3},{label:'75 %',seconds:3},{label:'100 %',seconds:3},{label:'75 %',seconds:3},{label:'50 %',seconds:3},{label:'25 %',seconds:3}],
            base:{cycles:4, restBetweenCycles:20}, profile:'elevator',
            help:{
              tech:['Dosez la contraction par paliers ; posture rel√¢ch√©e.'],
              breath:['Montez en expirant, descendez en inspirant.'],
              errors:['√âvitez la crispation √©paules/nuque.'],
              progress:['Passez √† 4 s/palier si confortable.']
            }
          },
          { id:'knack', name:'Knack (r√©flexe, sans timer)', type:'info',
            help:{
              tech:['Juste avant un moment cl√© (intromission, changement de position), contractez 1‚Äì2 s puis rel√¢chez.'],
              breath:['Soufflez court pendant le ‚Äúknack‚Äù.'],
              tips:['Entra√Ænez 3‚Äì4√ó dans la journ√©e, hors rapport.']
            }
          }
        ]
      },
      {
        id:'control', name:'Contr√¥le √©jaculatoire', exercises:[
          { id:'reverse', name:'Reverse Kegels (rel√¢che actif)', type:'interval', labels:{work:'Rel√¢che', rest:'Neutre'},
            base:{work:15, rest:10, reps:8, cycles:1, restBetweenCycles:0}, profile:'reverse',
            help:{
              tech:['√Ä l‚Äôinspiration, laissez ‚Äúdescendre/s‚Äôouvrir‚Äù (aucune pouss√©e).'],
              breath:['Inspire = rel√¢che ; expire = retour neutre.'],
              errors:['√âvitez toute contraction forte au pic d‚Äôexcitation.'],
              progress:['Allongez la rel√¢che si confortable.']
            }
          },
          { id:'breath', name:'Respiration coupl√©e (6/6)', type:'sequence',
            steps:[{label:'Inspire (rel√¢che)',seconds:6},{label:'Expire (contrac. douce 20‚Äì30%)',seconds:6}],
            base:{cycles:10, restBetweenCycles:0}, profile:'breath',
            help:{
              tech:['Contraction douce seulement pendant l‚Äôexpiration.'],
              breath:['Rythme r√©gulier 6/6.'],
              errors:['Pas de blocage de souffle ; intensit√© l√©g√®re.'],
              progress:['Passez √† 8/8 si besoin.']
            }
          },
          { id:'stopstart', name:'Stop‚ÄìStart guid√© (hors acte)', type:'sequence',
            steps:[{label:'Contraction douce',seconds:5},{label:'Rel√¢che',seconds:10}],
            base:{cycles:10, restBetweenCycles:0}, profile:'stopstart',
            help:{
              tech:['Alternez douce contraction et rel√¢chement pour entra√Æner le ‚Äúfreinage‚Äù.'],
              breath:['Expirez pendant la phase douce ; inspirez au rel√¢che.'],
              errors:['Restez √† 20‚Äì30 % d‚Äôintensit√©.'],
              progress:['Allongez le rel√¢che √† 12‚Äì15 s si besoin.']
            }
          },
          { id:'fine', name:'Ascenseur dosage fin (10‚Üí50‚Üí10 %)', type:'sequence',
            steps:[{label:'10 %',seconds:2},{label:'20 %',seconds:2},{label:'30 %',seconds:2},{label:'40 %',seconds:2},{label:'50 %',seconds:2},{label:'40 %',seconds:2},{label:'30 %',seconds:2},{label:'20 %',seconds:2},{label:'10 %',seconds:2}],
            base:{cycles:4, restBetweenCycles:20}, profile:'fine',
            help:{
              tech:['Travail de ‚Äúmolette‚Äù pour doser l‚Äôexcitation.'],
              breath:['Montez en expirant, descendez en inspirant.'],
              errors:['Fuyez la crispation globale.'],
              progress:['Passez √† 3 s/palier si confortable.']
            }
          }
        ]
      },
      {
        id:'orgasm', name:'Intensit√© de l‚Äôorgasme / jet', exercises:[
          { id:'pulses', name:'Pulses (rythme expulsif)', type:'interval', labels:{work:'Pulse', rest:'Rel√¢che'},
            base:{work:1, rest:1, reps:20, cycles:1, restBetweenCycles:0}, profile:'pulses',
            help:{
              tech:['Contractions br√®ves, rythm√©es, sans augmenter la pression abdominale.'],
              breath:['Souffle libre ; micro‚Äëexpirs possibles.'],
              errors:['Pas de crispation globale.'],
              progress:['Ajoutez 2‚Äì4 pulses quand c‚Äôest facile.']
            }
          },
          { id:'short', name:'Tenues courtes (30‚Äì40%)', type:'interval', labels:{work:'Tenue courte', rest:'Repos court'},
            base:{work:3, rest:4, reps:12, cycles:1, restBetweenCycles:0}, profile:'short',
            help:{
              tech:['Tonus mod√©r√© (30‚Äì40 %) juste avant rel√¢che.'],
              breath:['Expirez pendant la tenue, inspirez au repos.'],
              errors:['Ne basculez pas en contraction forte.'],
              progress:['Passez √† 15 r√©p√©titions au besoin.']
            }
          }
        ]
      },
      {
        id:'comfort', name:'Confort / d√©tente (tension pelvienne)', exercises:[
          { id:'revtonic', name:'Reverse toniques (anti‚Äëtension)', type:'interval', labels:{work:'Rel√¢che', rest:'Neutre'},
            base:{work:20, rest:10, reps:10, cycles:1, restBetweenCycles:0}, profile:'reverse',
            help:{
              tech:['Sentez l‚Äôouverture √† l‚Äôinspiration, laissez le ventre se gonfler.'],
              breath:['Respiration basse, lente.'],
              errors:['Aucune contraction volontaire pendant ‚ÄúRel√¢che‚Äù.'],
              progress:['Augmentez la rel√¢che jusqu‚Äô√† 25‚Äì30 s si besoin.']
            }
          },
          { id:'diaph', name:'Respiration diaphragmatique (fiche)', type:'info',
            help:{
              tech:['Allong√©, mains sur le bas‚Äëventre : inspirez (ventre monte), expirez longuement.'],
              tips:['5‚Äì10 respirations, 2‚Äì3 postures (papillon, happy baby, 90‚Äë90).']
            }
          }
        ]
      }
    ];

    // ====== Pr√©f√©rences & outils ======
    const storeKey = 'kegelSexDiffV1';
    const LS = {
      get k(){ try{ return JSON.parse(localStorage.getItem(storeKey)||'{}'); }catch(e){ return {}; } },
      set k(v){ try{ localStorage.setItem(storeKey, JSON.stringify(v)); }catch(e){} }
    };
    function savePref(key,val){ const s=LS.k; s[key]=val; LS.k=s; }

    const $$ = sel => document.querySelector(sel);
    function $(id){ return document.getElementById(id); }
    function fmt(ms){ const s=Math.max(0,Math.ceil(ms/1000)); const m=Math.floor(s/60); const r=s%60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`; }
    function clamp(n,a,b){ return Math.max(a,Math.min(b,n)); }
    function lerp(a,b,t){ return a+(b-a)*t; }
    function roundSec(x){ return Math.max(1, Math.round(x)); }
    function sumSeconds(steps){ return steps.reduce((a,b)=>a+(b.seconds||0),0); }

    // ====== Audio / Vibration / Wake Lock ======
    let audioCtx=null;
    function ensureAudio(){ if(!audioCtx){ try{ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }catch(e){} } return audioCtx; }
    function beep(freq=600, ms=120){
      if(!$('soundToggle').checked) return;
      const ctx=ensureAudio(); if(!ctx) return;
      const o=ctx.createOscillator(); const g=ctx.createGain();
      o.type='sine'; o.frequency.value=freq;
      g.gain.setValueAtTime(0.0001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.35, ctx.currentTime+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+ms/1000);
      o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+ms/1000+0.05);
    }
    function vib(pattern=100){ if(navigator.vibrate && $('vibrateToggle').checked){ navigator.vibrate(pattern); } }
    let wakeLock=null;
    async function requestWake(){ try{ if('wakeLock' in navigator && $('wakeToggle').checked){ wakeLock=await navigator.wakeLock.request('screen'); } }catch(e){} }
    async function releaseWake(){ try{ if(wakeLock){ await wakeLock.release(); wakeLock=null; } }catch(e){} }
    document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible' && $('wakeToggle').checked){ requestWake(); } });

    // ====== S√©lecteurs & Aide ======
    const catSelect=$('catSelect'), exSelect=$('exSelect'), exSummary=$('exSummary'), helpContent=$('helpContent');
    function renderCats(){
      catSelect.innerHTML='';
      CATEGORIES.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; catSelect.appendChild(o); });
      catSelect.value = LS.k.lastCat || CATEGORIES[0].id;
      renderExercises();
    }
    function currentCat(){ return CATEGORIES.find(c=>c.id===catSelect.value) || CATEGORIES[0]; }
    function currentExercise(){ const cat=currentCat(); return cat.exercises.find(e=>e.id===exSelect.value) || cat.exercises[0]; }
    function renderExercises(){
      const cat=currentCat();
      exSelect.innerHTML='';
      cat.exercises.forEach(x=>{ const o=document.createElement('option'); o.value=x.id; o.textContent=x.name + (x.type==='info'?' (fiche)':''); exSelect.appendChild(o); });
      const pref=LS.k.lastEx && cat.exercises.some(e=>e.id===LS.k.lastEx) ? LS.k.lastEx : cat.exercises[0].id;
      exSelect.value=pref;
      savePref('lastCat', cat.id);
      renderExerciseInfo();
    }

    // ====== Difficult√© globale (1..10) ======
    let difficulty = clamp(parseInt(LS.k.difficulty??5,10)||5, 1, 10); // d√©faut: 5/10
    const diffBar = $('diffBar'), diffText=$('diffText');
    function diffLabel(d){
      if(d<=3) return `${d}/10 ‚Äî Facile`;
      if(d<=7) return `${d}/10 ‚Äî Mod√©r√©`;
      return `${d}/10 ‚Äî Avanc√©`;
    }
    function updateDiffUI(){
      diffBar.setAttribute('aria-valuenow', String(difficulty));
      diffText.textContent = diffLabel(difficulty);
      [...diffBar.children].forEach((cell,i)=>{ cell.classList.toggle('active', i < difficulty); });
      // Mettre √† jour l'aide/les r√©sum√©s selon difficult√©
      renderExerciseInfo(); // n'interrompt pas un timer en cours
    }
    function buildDiffBar(){
      diffBar.innerHTML='';
      for(let i=1;i<=10;i++){
        const cell=document.createElement('div');
        cell.className='cell'; if(i<=difficulty) cell.classList.add('active');
        cell.title=`Niveau ${i}`;
        cell.addEventListener('click', ()=>{
          difficulty=i; savePref('difficulty', difficulty); updateDiffUI();
        });
        diffBar.appendChild(cell);
      }
      diffBar.addEventListener('keydown',(e)=>{
        if(e.key==='ArrowRight'){ difficulty=clamp(difficulty+1,1,10); savePref('difficulty',difficulty); updateDiffUI(); }
        if(e.key==='ArrowLeft'){ difficulty=clamp(difficulty-1,1,10); savePref('difficulty',difficulty); updateDiffUI(); }
      });
      updateDiffUI();
    }

    // ====== Adaptation des exercices √† la difficult√© ======
    // t ‚àà [0,1] mappe 1..10 ‚Üí 0..1
    function tFromD(d){ return (clamp(d,1,10)-1)/9; }

    function intensityAdvice(d){
      if(d<=3) return 'Intensit√© conseill√©e¬†: 20‚Äì40¬†% (position allong√©/assis).';
      if(d<=7) return 'Intensit√© conseill√©e¬†: 40‚Äì60¬†% (assis/debout).';
      return 'Intensit√© conseill√©e¬†: 60‚Äì75¬†% (debout/en mouvement, jamais 100¬†%).';
    }

    // Renvoie un "exercice r√©gl√©" pour la difficult√© courante
    function tuneExercise(ex, d){
      const t = tFromD(d);
      const copy = JSON.parse(JSON.stringify(ex)); // clone simple

      if(ex.type==='interval'){
        let {work,rest,reps,cycles,restBetweenCycles} = ex.base;
        switch(ex.profile){
          case 'endurance': {
            const fW = lerp(0.70, 1.60, t);
            const fR = lerp(1.30, 0.70, t);
            const fN = lerp(0.80, 1.30, t);
            work = roundSec(work * fW);
            rest = roundSec(rest * fR);
            reps = Math.max(1, Math.round(reps * fN));
            break;
          }
          case 'quick': {
            // Pulses: garder 1/1 mais augmenter le volume (reps) et √©ventuellement les cycles
            const repsMin=18, repsMax=42;
            reps = Math.max(8, Math.round(lerp(repsMin, repsMax, t)));
            work = 1; rest = 1;
            cycles = t>0.7 ? 2 : 1;
            restBetweenCycles = cycles>1 ? 20 : 0;
            break;
          }
          case 'longholds': {
            const fW = lerp(0.60, 2.00, t);
            const fR = lerp(1.20, 0.95, t);
            const fN = lerp(0.70, 1.10, t);
            work = roundSec(work * fW);
            rest = roundSec(rest * fR);
            reps = Math.max(1, Math.round(reps * fN));
            break;
          }
          case 'pulses': {
            const repsMin=12, repsMax=28;
            reps = Math.round(lerp(repsMin, repsMax, t));
            work = 1;
            rest = roundSec(lerp(1.2, 0.6, t)); // repos un peu plus court en haut
            break;
          }
          case 'short': {
            // Tenues courtes: augmenter l√©g√®rement la tenue, r√©duire un peu le repos, +reps
            const fW = lerp(0.7, 1.5, t);
            const fR = lerp(1.2, 0.8, t);
            const fN = lerp(0.9, 1.25, t);
            work = roundSec(work * fW);
            rest = roundSec(rest * fR);
            reps = Math.max(1, Math.round(reps * fN));
            break;
          }
          case 'reverse': {
            // "Plus difficile" = davantage de temps pass√© √† rel√¢cher / plus de volume
            const fW = lerp(1.0, 1.6, t); // rel√¢che plus longue
            const fN = lerp(0.8, 1.3, t);
            work = roundSec(work * fW);
            rest = roundSec(rest * lerp(1.0, 0.9, t));
            reps = Math.max(1, Math.round(reps * fN));
            break;
          }
          default: break;
        }
        copy.tuned = { type:'interval', labels:ex.labels, work, rest, reps, cycles:cycles??1, restBetweenCycles:restBetweenCycles??0 };
      }
      else if(ex.type==='sequence'){
        let steps = ex.steps.map(s=>({label:s.label, seconds:s.seconds}));
        let {cycles, restBetweenCycles} = ex.base;
        switch(ex.profile){
          case 'pyramid': {
            const f = lerp(0.85, 1.40, t);
            steps = steps.map(s=>({label:s.label, seconds: roundSec(s.seconds * f)}));
            cycles = t>0.65 ? 2 : 1;
            restBetweenCycles = cycles>1 ? 25 : 0;
            break;
          }
          case 'elevator': {
            const dur = roundSec(lerp(2, 4, t)); // secondes par palier
            steps = steps.map(s=>({label:s.label, seconds: dur}));
            cycles = Math.round(lerp(3, 5, t));
            restBetweenCycles = 20;
            break;
          }
          case 'breath': {
            // 4/4 ‚Üí 8/8 selon difficult√©
            const sec = roundSec(lerp(4, 8, t));
            steps = [{label:'Inspire (rel√¢che)',seconds:sec},{label:'Expire (contrac. douce 20‚Äì30%)',seconds:sec}];
            cycles = Math.round(lerp(8, 12, t));
            restBetweenCycles = 0;
            break;
          }
          case 'stopstart': {
            const soft = roundSec(lerp(4, 6, t));
            const relax = roundSec(lerp(10, 12, t));
            steps = [{label:'Contraction douce',seconds:soft},{label:'Rel√¢che',seconds:relax}];
            cycles = Math.round(lerp(8, 12, t));
            restBetweenCycles = 0;
            break;
          }
          case 'fine': {
            const dur = roundSec(lerp(2, 3, t));
            steps = steps.map(s=>({label:s.label, seconds: dur}));
            cycles = Math.round(lerp(3, 5, t));
            restBetweenCycles = 20;
            break;
          }
          default: break;
        }
        copy.tuned = { type:'sequence', steps, cycles:cycles??1, restBetweenCycles:restBetweenCycles??0 };
      }
      else {
        copy.tuned = { type:'info' };
      }

      // Aide: ins√©rer un conseil d‚Äôintensit√© selon la difficult√©
      const intens = intensityAdvice(d);
      copy.help = copy.help || {};
      copy.help.intensity = intens;
      return copy;
    }

    // ====== Affichage info & r√©sum√© d‚Äôun exercice ======
    function renderExerciseInfo(){
      const raw = currentExercise();
      const ex = tuneExercise(raw, difficulty);

      // R√©sum√© (badges)
      exSummary.innerHTML='';
      const badges=[];
      if(ex.tuned.type==='interval'){
        const total = ex.tuned.reps*(ex.tuned.work+ex.tuned.rest)*(ex.tuned.cycles||1) + (ex.tuned.restBetweenCycles||0)*Math.max(0,(ex.tuned.cycles||1)-1);
        badges.push(`${ex.labels.work}: ${ex.tuned.work}s`, `${ex.labels.rest}: ${ex.tuned.rest}s`, `R√©p√©titions: ${ex.tuned.reps}`, `Cycles: ${ex.tuned.cycles}`, `Total ~ ${total}s`);
      } else if(ex.tuned.type==='sequence'){
        const total = sumSeconds(ex.tuned.steps)*(ex.tuned.cycles||1) + (ex.tuned.restBetweenCycles||0)*Math.max(0,(ex.tuned.cycles||1)-1);
        badges.push(`√âtapes: ${ex.tuned.steps.length}`, `Cycles: ${ex.tuned.cycles}`, `Total ~ ${total}s`);
      } else {
        badges.push('Fiche aide (pas de timer)');
      }
      badges.forEach(t=>{ const s=document.createElement('span'); s.className='badge'; s.textContent=t; exSummary.appendChild(s); });

      // Aide
      helpContent.innerHTML='';
      const h = ex.help || {};
      function addSection(title, arr){
        if(!arr || !arr.length) return;
        const sec=document.createElement('div');
        const h3=document.createElement('div'); h3.style.fontWeight='700'; h3.style.marginTop='6px'; h3.textContent=title; sec.appendChild(h3);
        const ul=document.createElement('ul'); arr.forEach(x=>{ const li=document.createElement('li'); li.textContent=x; ul.appendChild(li); }); sec.appendChild(ul);
        helpContent.appendChild(sec);
      }
      addSection('Technique', h.tech);
      addSection('Respiration', h.breath||h.respiration);
      addSection('Erreurs fr√©quentes', h.errors);
      addSection('Conseils / Progression', h.progress||h.tips);
      addSection('Intensit√© & position (auto)', [h.intensity]);

      // Ajuste l‚Äôaffichage initial du timer
      updateUIForExercise();
    }

    // ====== Construction des √©tapes pour le timer ======
    function buildSteps(exTuned){
      const steps=[];
      if(exTuned.type==='interval'){
        const block=[{label: exTuned.labels?.work || 'Travail', seconds: exTuned.work},{label: exTuned.labels?.rest || 'Repos', seconds: exTuned.rest}];
        for(let c=0;c<(exTuned.cycles||1);c++){
          for(let r=0;r<exTuned.reps;r++) steps.push(...block);
          if(c < (exTuned.cycles||1)-1 && (exTuned.restBetweenCycles||0)>0){
            steps.push({label:'Repos entre cycles', seconds: exTuned.restBetweenCycles});
          }
        }
      } else if(exTuned.type==='sequence'){
        for(let c=0;c<(exTuned.cycles||1);c++){
          steps.push(...exTuned.steps);
          if(c < (exTuned.cycles||1)-1 && (exTuned.restBetweenCycles||0)>0){
            steps.push({label:'Repos entre cycles', seconds: exTuned.restBetweenCycles});
          }
        }
      }
      return steps;
    }

    // ====== Timer ======
    const STATE={IDLE:'IDLE', RUNNING:'RUNNING', PAUSED:'PAUSED', DONE:'DONE'};
    let state=STATE.IDLE;
    let steps=[], idx=0, msLeft=0, msStep=0, timerId=null;

    const phaseLabel=$('phaseLabel'), timeDisplay=$('timeDisplay'), stepDisplay=$('stepDisplay'), stepDurDisplay=$('stepDurDisplay'), progressBar=$('progressBar');
    const startBtn=$('startBtn'), pauseBtn=$('pauseBtn'), resetBtn=$('resetBtn');

    function updateUI(){
      if(state===STATE.IDLE || !steps.length){
        phaseLabel.textContent='Pr√™t'; timeDisplay.textContent='00:00'; stepDisplay.textContent='0'; stepDurDisplay.textContent='0s'; progressBar.style.width='0%'; return;
      }
      phaseLabel.textContent = steps[idx]?.label || '√âtape';
      timeDisplay.textContent = fmt(msLeft);
      stepDisplay.textContent = `${idx+1} / ${steps.length}`;
      stepDurDisplay.textContent = `${Math.round(msStep/1000)}s`;
      const p = 100 - Math.round((msLeft/msStep)*100);
      progressBar.style.width = `${clamp(p,0,100)}%`;
      document.querySelector('.progress').setAttribute('aria-valuenow', String(clamp(p,0,100)));
    }
    function setButtons(){
      const raw=currentExercise();
      startBtn.disabled = (state===STATE.RUNNING) || raw.type==='info';
      pauseBtn.disabled = !(state===STATE.RUNNING || state===STATE.PAUSED);
      resetBtn.disabled = (state===STATE.IDLE);
      pauseBtn.textContent = state===STATE.PAUSED ? 'Reprendre' : 'Pause';
    }
    function start(){
      const tuned = tuneExercise(currentExercise(), difficulty).tuned;
      if(tuned.type==='info'){ alert('Cet √©l√©ment est une fiche aide (pas de timer). Choisissez un exercice chronom√©tr√©.'); return; }
      steps = buildSteps(tuned);
      if(!steps.length){ alert('Aucune √©tape √† ex√©cuter.'); return; }
      idx=0; msLeft=steps[0].seconds*1000; msStep=msLeft;
      state=STATE.RUNNING; setButtons(); updateUI();
      beep(900,150); vib([120,60,120]); timerId=setInterval(tick,100);
      if($('wakeToggle').checked) requestWake();
    }
    function nextStep(){
      idx++;
      if(idx>=steps.length){ finish(); return; }
      msLeft=steps[idx].seconds*1000; msStep=msLeft; updateUI(); beep(700,120); vib(60);
    }
    function tick(){ if(state!==STATE.RUNNING) return; msLeft-=100; if(msLeft<=0){ nextStep(); } updateUI(); }
    function pause(){ if(state===STATE.RUNNING){ state=STATE.PAUSED; setButtons(); beep(300,100); releaseWake(); } else if(state===STATE.PAUSED){ state=STATE.RUNNING; setButtons(); beep(700,100); if($('wakeToggle').checked) requestWake(); } }
    function reset(){ state=STATE.IDLE; clearInterval(timerId); timerId=null; steps=[]; idx=0; msLeft=0; msStep=0; updateUI(); setButtons(); releaseWake(); }
    function finish(){ state=STATE.DONE; clearInterval(timerId); timerId=null; updateUI(); setButtons(); releaseWake();
      setTimeout(()=>beep(880,120),0); setTimeout(()=>beep(660,120),160); setTimeout(()=>beep(990,160),320); vib([120,60,120,60,200]); phaseLabel.textContent='Termin√© üéâ';
    }

    function updateUIForExercise(){
      const tuned = tuneExercise(currentExercise(), difficulty).tuned;
      if(tuned.type==='interval'){ phaseLabel.textContent = currentExercise().labels?.work || 'Travail'; }
      else if(tuned.type==='sequence'){ phaseLabel.textContent = tuned.steps?.[0]?.label || '√âtape'; }
      else { phaseLabel.textContent = 'Fiche'; }
      setButtons(); updateUI();
    }

    // ====== √âv√©nements ======
    catSelect.addEventListener('change', ()=>{ renderExercises(); reset(); });
    exSelect.addEventListener('change', ()=>{ savePref('lastEx', exSelect.value); renderExerciseInfo(); reset(); });
    $('soundToggle').addEventListener('change', ()=>savePref('soundOn', $('soundToggle').checked));
    $('vibrateToggle').addEventListener('change', ()=>savePref('vibOn', $('vibrateToggle').checked));
    $('wakeToggle').addEventListener('change', ()=>{ savePref('wakeOn', $('wakeToggle').checked); if(!$('wakeToggle').checked) releaseWake(); });

    startBtn.addEventListener('click', start);
    pauseBtn.addEventListener('click', pause);
    resetBtn.addEventListener('click', reset);

    // ====== Init ======
    // Pr√©f√©rences
    $('soundToggle').checked = !!(LS.k.soundOn);
    $('vibrateToggle').checked = !!(LS.k.vibOn);
    $('wakeToggle').checked = !!(LS.k.wakeOn);
    renderCats();
    buildDiffBar();
    updateUI(); setButtons();

    // Accessibilit√©: Espace = d√©marrer/pause, √âchap = reset
    document.addEventListener('keydown', (e)=>{
      if(e.code==='Space'){ e.preventDefault(); if(state===STATE.RUNNING || state===STATE.PAUSED) pause(); else start(); }
      if(e.code==='Escape'){ reset(); }
    });
  </script>
</body>
</html>
